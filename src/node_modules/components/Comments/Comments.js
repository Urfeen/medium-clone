import React, { useState, useEffect } from 'react';
import Comment from "components/Comments/Comment.js";
import CommentNew from "components/Comments/CommentNew.js";
import { projectDB } from "firebaseConfig/firebaseConfig.js";
import moment from "moment";

const Comments = ({ currentLang, articleId, feedComments, setFeedComments }) => {
  const addNewComment = (e, commentText, setIsError, textFieldRef, setCommentText) => {
    e.preventDefault();
    if (commentText.length === 0) {
      setIsError(true);
      return;
    }
    const timestamp = Date.now();
    const comment = {
      commentText: commentText.trim(),
      owner: localStorage.getItem("currentUserId"),
      likes: 0,
      dislikes: 0,
    }
    projectDB.ref('articles/' + articleId + "/" + "comments/" + timestamp).set(comment)
      .then(() => {
        setCommentText("");
        textFieldRef.current.focus();
        setFeedComments(prevState => ({
          ...prevState,
          [timestamp]: comment,
        }))
      })
  }
  return (
    <div style={{ display: "grid", gap: "10px" }}>
      <CommentNew currentLang={currentLang} addNewComment={addNewComment} />
      {Object.entries(feedComments).reverse().map(comment => {
        return (
          <Comment
            key={comment[0]}
            commentText={comment[1].commentText}
            dislikes={comment[1].dislikes}
            likes={comment[1].likes}
            owner={comment[1].owner}
            publishedDate={moment(new Date(+comment[0])).format("DD.MM.YYYY")}
          />
        )
      })}
    </div>
  );
}

export default Comments;